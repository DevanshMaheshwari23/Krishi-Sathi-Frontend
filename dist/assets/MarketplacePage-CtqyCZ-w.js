import{c as S,j as e,R,f as $,O as B,C as H,g as Y,D as V,h as Q,X as J,i as w,r as i,k as W,B as p,S as X,z as P,b as G,L as I,l as M,e as D,m as K,n as v,P as Z}from"./index-DguWN4vU.js";import{a as ee}from"./api-CjXNmGHq.js";import{P as se,a as te,F as ae,C,E as re}from"./PageShell-BiW79PkF.js";import{I as b}from"./Input-RXoSGTuU.js";import{T as le,I as ie}from"./Textarea-P4RECWhU.js";import{M as ne}from"./mail-CwAkgUFa.js";import{P as ce}from"./phone-BJofUnAo.js";import{S as oe}from"./sparkles-DQtvFYIb.js";import{M as de}from"./map-pin-BeXUVN_-.js";import{C as me}from"./calendar-DAVEQ2O-.js";import{E as xe}from"./eye-BehaAQu1.js";const he=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],pe=S("funnel",he);const ue=[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]],ge=S("share-2",ue);const je=[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]],fe=S("star",je),ve={state:"",district:"",pincode:""},Ne=s=>{const a=s.cropName??s.cropType??"Unknown Crop";return{_id:s._id??`${a}-${Date.now()}`,sellerId:s.sellerId,seller:s.seller,type:s.type,cropName:a,cropType:a,quantity:s.quantity??0,unit:s.unit??"kg",pricePerUnit:s.pricePerUnit??0,location:{...ve,...s.location??{}},harvestDate:s.harvestDate,description:s.description,images:s.images??[],status:s.status??"active",views:s.views??0,createdAt:s.createdAt,updatedAt:s.updatedAt}},be=s=>s.map(Ne),ye=({open:s,onOpenChange:a,title:d,description:m,children:c,className:n})=>e.jsx(R,{open:s,onOpenChange:a,children:e.jsxs($,{children:[e.jsx(B,{className:"fixed inset-0 z-50 bg-black/45 backdrop-blur-sm"}),e.jsxs(H,{className:w("fixed left-1/2 top-1/2 z-50 w-[92vw] max-w-xl -translate-x-1/2 -translate-y-1/2 rounded-[var(--radius-lg)] border border-[var(--border)] bg-[var(--surface)] p-6 shadow-[var(--shadow-card-hover)]",n),children:[e.jsxs("div",{className:"mb-4 flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(Y,{className:"font-[var(--font-display)] text-xl font-bold text-[var(--text)]",children:d}),m?e.jsx(V,{className:"mt-1 text-sm text-[var(--text-muted)]",children:m}):null]}),e.jsx(Q,{asChild:!0,children:e.jsx("button",{type:"button",className:"rounded-[var(--radius-md)] p-2 text-[var(--text-muted)] transition hover:bg-[var(--surface-muted)] hover:text-[var(--text)]","aria-label":"Close",children:e.jsx(J,{className:"h-4 w-4"})})})]}),e.jsx("div",{children:c})]})]})}),we=({isOpen:s,onClose:a,sellerName:d,sellerEmail:m,cropName:c})=>{const[n,u]=i.useState({name:"",email:"",phone:"",message:`Hi, I'm interested in your ${c} listing. Please share availability details.`}),[x,g]=i.useState(!1),h=async r=>{r.preventDefault(),g(!0),await new Promise(l=>setTimeout(l,1e3)),P.success(`Message sent to ${d}`),g(!1),a()};return e.jsx(ye,{open:s,onOpenChange:r=>{r||a()},title:"Contact Seller",description:`Reach out to ${d} about ${c}`,children:e.jsxs("form",{onSubmit:h,className:"space-y-4",children:[e.jsxs("div",{className:"surface-subtle p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted",children:[e.jsx(ne,{className:"h-4 w-4"}),e.jsx("span",{children:m})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-sm text-muted",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsxs("span",{children:["Listing: ",c]})]})]}),e.jsx(b,{label:"Your Name",required:!0,value:n.name,onChange:r=>u(l=>({...l,name:r.target.value})),placeholder:"John Doe"}),e.jsx(b,{label:"Your Email",type:"email",required:!0,value:n.email,onChange:r=>u(l=>({...l,email:r.target.value})),placeholder:"john@example.com"}),e.jsxs("div",{className:"relative",children:[e.jsx(ce,{className:"pointer-events-none absolute left-3 top-10 h-4 w-4 text-soft"}),e.jsx(b,{label:"Phone Number",value:n.phone,onChange:r=>u(l=>({...l,phone:r.target.value})),className:"pl-10",placeholder:"+91 98765 43210"})]}),e.jsx(le,{label:"Message",required:!0,rows:4,value:n.message,onChange:r=>u(l=>({...l,message:r.target.value}))}),e.jsxs("div",{className:"flex items-center justify-end gap-2 pt-2",children:[e.jsx(p,{type:"button",variant:"secondary",onClick:a,children:"Cancel"}),e.jsxs(p,{type:"submit",loading:x,children:[e.jsx(X,{className:"h-4 w-4"}),"Send Message"]})]})]})})},Ce=["All","Wheat","Rice","Cotton","Sugarcane","Potato","Tomato","Onion"],y=[{label:"All prices",min:0,max:Number.POSITIVE_INFINITY},{label:"Under ₹50",min:0,max:50},{label:"₹50 - ₹100",min:50,max:100},{label:"₹100 - ₹200",min:100,max:200},{label:"Above ₹200",min:200,max:Number.POSITIVE_INFINITY}],Ee=()=>{const{user:s}=G(),[a,d]=i.useState([]),[m,c]=i.useState(!0),[n,u]=i.useState(""),[x,g]=i.useState("All"),[h,r]=i.useState(y[0]),[l,T]=i.useState("newest"),[O,_]=i.useState(!1),[f,q]=i.useState({total:0,page:1,pages:1}),[j,k]=i.useState({isOpen:!1,listing:null}),A=i.useCallback(async()=>{c(!0);try{const t=await ee.get("/listings",{params:{page:f.page,limit:12,status:"active"}});d(be(t.data.items)),q({total:t.data.total,page:t.data.page,pages:t.data.pages})}catch(t){console.error("Failed to fetch listings",t),P.error("Failed to load listings"),d([])}finally{c(!1)}},[f.page]);i.useEffect(()=>{A()},[A]);const N=i.useMemo(()=>a.filter(t=>{const o=t.cropName.toLowerCase(),E=t.location?.district?.toLowerCase()??"",L=n.toLowerCase(),F=o.includes(L)||E.includes(L),U=x==="All"||t.cropName===x,z=t.pricePerUnit>=h.min&&t.pricePerUnit<=h.max;return F&&U&&z}).sort((t,o)=>l==="price-low"?t.pricePerUnit-o.pricePerUnit:l==="price-high"?o.pricePerUnit-t.pricePerUnit:new Date(o.createdAt||0).getTime()-new Date(t.createdAt||0).getTime()),[a,n,x,h,l]);return e.jsxs(se,{children:[e.jsx(te,{badge:e.jsxs(D,{className:"bg-white/20 text-white border-white/35",children:[e.jsx(oe,{className:"h-3.5 w-3.5"}),f.total," active listings"]}),title:"Marketplace",description:"Browse crop offers, compare pricing, and connect directly with farmers and buyers.",actions:s?.role==="farmer"?e.jsx(I,{to:"/marketplace/create",children:e.jsxs(p,{children:[e.jsx(M,{className:"h-4 w-4"}),"Create listing"]})}):null}),e.jsxs("section",{className:"mt-6",children:[e.jsxs(ae,{children:[e.jsxs("div",{className:"relative w-full md:max-w-md",children:[e.jsx(K,{className:"pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-soft"}),e.jsx("input",{type:"text",className:"field-base pl-10",placeholder:"Search crop or district",value:n,onChange:t=>u(t.target.value)})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("select",{className:"field-base min-w-40",value:l,onChange:t=>T(t.target.value),children:[e.jsx("option",{value:"newest",children:"Newest first"}),e.jsx("option",{value:"price-low",children:"Price low to high"}),e.jsx("option",{value:"price-high",children:"Price high to low"})]}),e.jsxs(p,{variant:"secondary",onClick:()=>_(t=>!t),children:[e.jsx(pe,{className:"h-4 w-4"}),"Filters"]})]})]}),O?e.jsx(C,{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 gap-5 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-muted",children:"Crop type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Ce.map(t=>e.jsx("button",{type:"button",onClick:()=>g(t),className:w("rounded-[var(--radius-pill)] border px-3 py-1.5 text-xs font-semibold transition",x===t?"border-[var(--primary)] bg-[var(--primary-soft)] text-[var(--primary)]":"border-[var(--border)] bg-[var(--surface-muted)] text-muted"),children:t},t))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-muted",children:"Price range"}),e.jsx("div",{className:"space-y-2",children:y.map(t=>e.jsx("button",{type:"button",onClick:()=>r(t),className:w("w-full rounded-[var(--radius-md)] border px-3 py-2 text-left text-sm font-semibold transition",h.label===t.label?"border-[var(--primary)] bg-[var(--primary-soft)] text-[var(--primary)]":"border-[var(--border)] bg-[var(--surface-muted)] text-muted"),children:t.label},t.label))})]}),e.jsxs("div",{children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-muted",children:"Active filters"}),e.jsxs("div",{className:"surface-subtle p-3 text-sm",children:[e.jsxs("p",{className:"text-muted",children:["Crop: ",x]}),e.jsxs("p",{className:"text-muted",children:["Price: ",h.label]}),e.jsx(p,{className:"mt-3",variant:"ghost",size:"sm",onClick:()=>{g("All"),r(y[0])},children:"Reset filters"})]})]})]})}):null,m?null:e.jsxs("p",{className:"mb-4 text-sm text-muted",children:["Showing ",e.jsx("strong",{children:N.length})," of ",f.total," listings"]}),m?e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3",children:Array.from({length:6}).map((t,o)=>e.jsxs(C,{children:[e.jsx(v,{className:"h-40 w-full"}),e.jsx(v,{className:"mt-3 h-6 w-2/3"}),e.jsx(v,{className:"mt-2 h-4 w-1/2"}),e.jsx(v,{className:"mt-4 h-10 w-full"})]},o))}):N.length===0?e.jsx(re,{title:"No listings found",description:n?"Try adjusting search and filters to find matching crop listings.":"No active listing matches your selected filters yet.",icon:e.jsx(Z,{className:"h-6 w-6"}),action:s?.role==="farmer"?e.jsx(I,{to:"/marketplace/create",children:e.jsxs(p,{children:[e.jsx(M,{className:"h-4 w-4"}),"Create your first listing"]})}):null}):e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3",children:N.map((t,o)=>e.jsx(Se,{listing:t,viewCount:t.views??120+o*7,rating:4.2+o%5*.1,onContact:()=>k({isOpen:!0,listing:t})},t._id))})]}),j.listing?e.jsx(we,{isOpen:j.isOpen,onClose:()=>k({isOpen:!1,listing:null}),sellerName:j.listing.seller?.name||"Seller",sellerEmail:j.listing.seller?.email||"Not available",cropName:j.listing.cropName}):null]})},Se=({listing:s,onContact:a,viewCount:d,rating:m})=>{const c=s.harvestDate?new Date(s.harvestDate).toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"}):"N/A";return e.jsxs(C,{interactive:!0,className:"surface-card-hover",children:[e.jsxs("div",{className:"mb-3 flex items-start justify-between gap-3",children:[e.jsx(D,{variant:"success",children:s.status||"active"}),e.jsx("button",{type:"button",onClick:()=>{navigator.clipboard.writeText(window.location.href),P.success("Listing link copied")},className:"inline-flex h-8 w-8 items-center justify-center rounded-[var(--radius-md)] border border-[var(--border)] text-soft hover:bg-[var(--surface-muted)]","aria-label":"Share listing",children:e.jsx(ge,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mb-4 rounded-[var(--radius-md)] bg-[var(--surface-muted)] p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold",children:s.cropName}),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-[var(--warning)]",children:[e.jsx(fe,{className:"h-4 w-4 fill-current"}),m.toFixed(1)]})]}),e.jsxs("p",{className:"mt-1 text-sm text-muted",children:[s.quantity," ",s.unit]}),e.jsxs("div",{className:"mt-3 flex items-center gap-1 text-2xl font-bold text-[var(--primary)]",children:[e.jsx(ie,{className:"h-5 w-5"}),e.jsx("span",{children:s.pricePerUnit.toLocaleString("en-IN")}),e.jsxs("span",{className:"text-sm font-semibold text-soft",children:["/ ",s.unit]})]})]}),e.jsxs("div",{className:"space-y-2 text-sm text-muted",children:[e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),s.location?.district||"N/A",", ",s.location?.state||"N/A"]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"Harvest date: ",c]}),e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),d," views"]})]}),e.jsxs("div",{className:"mt-5 flex items-center justify-between gap-3 border-t border-[var(--border)] pt-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:s.seller?.name||"Seller"}),e.jsx("p",{className:"text-xs text-soft",children:"Verified seller"})]}),e.jsx(p,{size:"sm",onClick:a,children:"Contact"})]})]})};export{Ee as MarketplacePage};
